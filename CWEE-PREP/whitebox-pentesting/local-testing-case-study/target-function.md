# üéØ Target Function

## Overview

Before exploitation, plan the attack as action points to track progress and identify issues.

---

## Attack Plan Checklist

| # | Step | Status |
|---|------|--------|
| 1 | Hit the validateString function | ‚úÖ |
| 2 | Trace how input looks within function | ‚úÖ |
| 3 | Obtain an admin role | ‚è≥ |
| 4 | Confirm we reach the eval function | ‚è≥ |
| 5 | Prepare the payload | ‚è≥ |
| 6 | Confirm payload reaches target as intended | ‚è≥ |
| 7 | Inject code and confirm injection | ‚è≥ |
| 8 | Reach command execution or file writing | ‚è≥ |
| 9 | Blindly verify command execution/file writing | ‚è≥ |
| 10 | Automate exploitation (write exploit) | ‚è≥ |

---

## Step 3: Obtain Admin Role

### Real-World Methods

| Method | Description |
|--------|-------------|
| Privilege escalation | Exploit to elevate permissions |
| Authorization flow | Legitimate admin access |
| XSS/CSRF | Attack admin user |
| Brute force | Guess admin credentials |
| Request access | Ask client for admin account |

> **Note**: If no vuln exists, request admin account. Impact is lower (only affects admin users).

### Our Case: Email-based Role

Looking at `getUserToken`:

```javascript
{
    email,
    role: email.includes("@hackthebox.com") ? "admin" : "user",
}
```

**Solution**: Use `@hackthebox.com` email domain!

### Get Admin Token

```bash
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{"email": "test@hackthebox.com"}' \
  http://localhost:5000/api/auth/authenticate
```

**Response**:
```json
{"token":"eyJhbGciOiJIUzI1N...SNIP...9R6zeoubrQTbUiThBpeQD7_DWibgo"}
```

### Verify Role in JWT

Use [jwt.io](https://jwt.io) to decode:

```json
{
  "email": "test@hackthebox.com",
  "role": "admin",  // ‚úÖ Admin!
  "iat": 1700865256,
  "exp": 1700951656
}
```

### Dynamic Verification (Debug)

1. Add breakpoint to line 30 (`service-controllers.js`)
2. Right-click `role` on line 17 ‚Üí "Add to Watch"
3. Send request with admin token
4. Check WATCH pane ‚Üí `role: "admin"`

‚úÖ **Step 3 Complete**: Admin role obtained

---

## Step 4: Reaching the Vulnerable Code

### validateString Conditions

```javascript
function validateString(input, onError) {
  if (
    typeof input !== "string" ||  // Condition 1
    input.length == 0 ||          // Condition 2
    input.match(/['"`;]/g)        // Condition 3
  ) {
    eval(onError);  // ‚Üê We need to reach here
    return false;
  }
  return true;
}
```

### Condition Analysis

| Condition | Triggers eval? | Input in onError? |
|-----------|----------------|-------------------|
| Not a string | ‚úÖ | ‚ùå No control |
| Empty string | ‚úÖ | ‚ùå No control |
| **Bad characters** | ‚úÖ | ‚úÖ **Yes!** |

**Must use Condition 3** - only way to have input in `onError`.

### Bad Characters

```javascript
/['"`;]/g
```

| Char | Effect |
|------|--------|
| `'` | Breaks strings |
| `"` | Breaks strings |
| `` ` `` | Breaks template literals |
| `;` | **Safest** - doesn't break `onError` string |

### Test with Semicolon

```bash
curl -s -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ADMIN_TOKEN>" \
  -d '{"text": ";"}' \
  http://localhost:5000/api/service/generate
```

**Response**:
```json
{"message":"The input \";\" contains the following invalid characters: [;]"}
```

### What This Confirms

1. ‚úÖ We reached the `eval` function
2. ‚úÖ `onError` string evaluated successfully
3. ‚úÖ We see the **verbose admin error message**
4. ‚úÖ Our input (`;`) appears in the message

‚úÖ **Step 4 Complete**: Reached vulnerable code

---

## Updated Checklist

| # | Step | Status |
|---|------|--------|
| 1 | Hit the validateString function | ‚úÖ |
| 2 | Trace how input looks within function | ‚úÖ |
| 3 | Obtain an admin role | ‚úÖ |
| 4 | Confirm we reach the eval function | ‚úÖ |
| 5 | Prepare the payload | ‚è≥ |
| 6 | Confirm payload reaches target as intended | ‚è≥ |
| 7 | Inject code and confirm injection | ‚è≥ |
| 8 | Reach command execution or file writing | ‚è≥ |
| 9 | Blindly verify command execution/file writing | ‚è≥ |
| 10 | Automate exploitation (write exploit) | ‚è≥ |

---

## Current Attack Flow

```
1. Get admin token (@hackthebox.com email)
         ‚Üì
2. Send request with bad character (;)
         ‚Üì
3. validateString fails condition 3
         ‚Üì
4. eval(onError) is called
         ‚Üì
5. Our input is in onError via ${text}
         ‚Üì
6. Verbose error returned (admin only)
```

---

## Next Steps

1. **Prepare payload** - Inject code without breaking syntax
2. **Confirm injection** - Verify code executes
3. **Achieve RCE** - Execute system commands
4. **Verify blindly** - Confirm execution without output
5. **Write exploit** - Automate the process

---

## Key Takeaways

1. **Plan before exploit** - Track progress, identify issues early
2. **Understand conditions** - Know exactly how to reach vulnerable code
3. **Choose input wisely** - `;` triggers eval without breaking string
4. **Verify each step** - Don't skip ahead, confirm before proceeding
5. **Use debugger** - Watch variables to verify understanding

